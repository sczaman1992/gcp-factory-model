# Flux - Step by step procedure to automate update the image versions (from Google artifacts to the GKE cluster )
---

## Part 1: Image repo connectivity with flux 
---
Note: If the flux commands are not fetched and applied automatically, can be applied manually by applying the commands without --export argument.
 
#### 1. To automate image versioning update  on GKE cluster using flux, you need to two addition flux controllers in bootstrap.
 
> export GITHUB_TOKEN=`<github token created from above step 7>`

> export GITHUB_USER=`<github username>`
 
You can update the bootstrap with flux like below ,
> flux bootstrap github \
   --owner=$GITHUB_USER \
   --repository=flux-demo-test1 \
   --branch=main \
   --path=clusters/flux-demo-cluster \
   --personal\
   --components-extra=image-reflector-controller,image-automation-controller
 
This operation will create two additions pods to flux-systems namespace
 
#### 2.	Create a secret on Kubernetes cluster to connect with image repo,
 
> kubectl create secret docker-registry artifact-registry \
--docker-server='https://us-central1-docker.pkg.dev' \
--docker-username=_json_key \
           --docker-password="$(cat secrets.json)" \
--docker-email=`<service account email address to connect with GCP artifacts>` \
--namespace=flux-kube-demo
 
Note: Service account used here should have the artifacts register reader permission and repositor reader permission.
service account access key need to generate for adding the password and once kubernetes secret generated, it can be deleted.
 
#### 3.  Create a directory in the 'Flux' repo for storing ImageRepository resources.
 
> cd gitops-lab-flux

> mkdir imagerepos
 
#### 4.  Create an ImageRepositpry resource for scanning the image tags associated with the nginxhello app, and write it to a file in the 'imagerepos'directory.
 
> flux create image repository nginx-image \
  --image=us-central1-docker.pkg.dev/poc-and-training/flux-image-demo-repo/nginx \
  --interval=1m \
  --namespace=flux-kube-demo \
  --secret-ref=artifact-registry \
  --export > flux-demo-test1/imagerepos/nginx-image-repo.yaml
 
#### 5.  Inspect the generated YAML resource, and make sure it contains all that is required.
 
> cat imagerepos/nginxhello-image-repo.yaml
 
#### 6.  Create a kustomization file for the 'imagerepos' directory.
 
> cd imagerepos

> kustomize create --autodetect
cd ..
 
#### 7.  Stage and commit changes, before pushing the changes to the remote 'gitops-lab-flux' repo.
 
> git add imagerepos/

> git commit -m "Add ImageRepository resource to configuration"

> git push
 
#### 8.  Give Flux enough time to fetch and apply the ImageRepository resource,check in on the cluster to make sure the resource has been created in the default namespace. Observe the time of the last scan, and the number of tags retrieved.
 
> kubectl get imagerepositories.image.toolkit.fluxcd.io
 
---
## Part 2: Creation of image policy to fetch the specific versions for the deployments:
--- 
 
#### 1.  Change directory into the root of the 'Flux' repo.
 
> cd gitops-lab-flux
 
#### 2.  Configure notifications for events generated by the image reflector controller related to image policy, by making an addition to the manifest in the notifications/alerts sub-directory (discord-bot-alert.yaml).Duplicate one of the event sources, and change its 'kind' to 'ImagePolicy'.
 
#### 3.  Make a directory to store ImagePolicy resources.
 
> mkdir ./imagepolicies
 
#### 4.  Create a SemVer type ImagePolicy resource for the nginxhello app's image    respository, to select image tags greater than or equal to the minor version '1.20.x'.
 
> flux create image policy flux-image-policy \
    --image-ref=nginx-image \
    --namespace=flux-kube-demo \
    --select-numeric=asc \
    --filter-regex='^V(?P<ts>[0-9]+)' \
    --filter-extract='$ts' \
    --export > imagepolicies/nginxhello-image-policy.yaml 
 
#### 5.  Inspect the generated YAML resource and make sure that it refelcts what you expect to see.
 
> cat imagepolicies/nginxhello-image-policy.yaml
 
#### 6.  Create a kustomization file for the 'imagepolicies' directory.
 
> cd imagepolicies
> kustomize create --autodetect
> cd ..
 
#### 7.  Stage and commit changes, before pushing the changes to the remote 'gitops-lab-flux' repo.
 
> git add -A

> git commit -m "Add ImagePolicy resource for nginxhello app"

> git push
 
#### 8.  Give Flux enough time to fetch and apply the ImagePolicy resource, check in    on the cluster to make sure the resource has been created in the default namespace. Check which image tag has been selected by the image reflector controller.
 
> kubectl get imagepolicies.image.toolkit.fluxcd.io
 
#### 9.  Is this image tag the same as the tag used by the current deployment of the    nginxhello app in the cluster? Remind yourself of the current version.
 
> kubectl get deployments.apps nginxhello -o yaml | \
  yq '.spec.template.spec.containers[0].image'
 
---
##Part 3: UPDATING AN APPLICATION VERSION WITH IMAGE AUTOMATION
---
 
#### 1.  Change directory into the root of the 'Deployment' repo.
 
> cd gitops-lab-deploy
 
#### 2.  Add a marker to the image field in the Deployment manifest using a setter    comment. Use your favorite text editor, or the 'sed' command to make the change.
 
> `sed -i 's/.*- image:.*$/& # {"$imagepolicy": "default:nginxhello"}/' \
  deploy/deployment.yaml`
 
If the above command didnâ€™t append the string, you can edit the deployment file which need to fetch the image and add below string after space after the image space like below,

 string to Append: # {"$imagepolicy": "default:nginxhello"}
 
> image: us-central1-docker.pkg.dev/`<project-id>`/flux-image-demo-repo/nginx:V3 # {"$imagepolicy": "flux-kube-demo:flux-image-policy"}
 
 
#### 3.  Stage and commit the changes, before pushing the changes to the remote    'gitops-lab-deploy' repo.
 
> git add -u

> git commit -m "Add marker to deployment manifest"

> git push
 
#### 4.  Give Flux enough time to fetch and apply the change, before checking in on the cluster. Make sure the GitRepository resource called 'nginxhello' has been updated, and has stored an artifact with the same commit hash as the hash created by the 'git commit' command.
 
> kubectl get gitrepositories.source.toolkit.fluxcd.io nginxhello
 
#### 5.  Change directory into the root of the 'Flux' repo.
 
> cd ../gitops-lab-flux
 
#### 6.  Create a directory for storing ImageUpdateAutomation resources.
 
> mkdir ./imageautos
 
#### 7.  Inspect, and maybe alter, the supplied commit message template in the file called 'msg_template'.
 
> cat ../msg_template
 
#### pls find the sample template file:
 
pls find the file in same directory.
[msg_template](https://github.com/gcp-coe/terraform-gcplz-modules/blob/af2676d7115e488a5d3f674a3eca784d0613f4b2/modules/flux_image_integration/msg_template)
 
#### 8.  Create an ImageUpdateAutomation resource for the nginxhello application,    and export it to the file 'nginxhello-image-automation.yaml' in the new 'imageautos' directory.
> flux create image update nginx-flux-demo \
  --git-repo-ref=demo-deployment \
  --git-repo-path=./deploy \
  --checkout-branch=main \
  --push-branch=main \
  --author-name=flux \
  --author-email=flux@users.noreply.github.com \
  --commit-template="$(cat msg_template)" \
  --namespace=flux-kube-demo \
  --export > flux-demo-test1/imageautos/nginixhello-image-automation.yaml
 
#### 9.  Inspect the geenerated YAML resource and make sure that it refelcts what you expect to see.
 
> cat imageautos/nginxhello-image-automation.yaml
 
#### 10. Create a kustomization file for the 'imageautos' directory.
 
> cd imageutos

> kustomize create --autodetect

> cd ..
 
#### 11. In a new terminal window, establish a watch on the app's pods running in the cluster, either by using the 'watch' capability built into the kubectl command (kubectl get po --watch), or by using the 'watch' utility.
 
> watch kubectl get po
 
#### 12. Back in the first terminal, stage and commit the changes before pushing them to the remote 'gitops-lab-flux' repo.
 
> git add imageautos/

> git commit -m "Add ImageUpdateAutomation resource for nginxhello app"

> git push
 
#### 13. Allowing time for Flux to sync the changes made to the desred state, and    whilst monitoring the watched pods in the other terminal window, get the    ImageUpdateAutomation resource from the cluster. Check to see when the last update was run by the image automation controller. Observe Kubernetes performing a rolling update to the app.
 
> kubectl get imageupdateautomations.image.toolkit.fluxcd.io
 
#### 14. What is the version of the nginxhello app running in the cluster? Does it reflect the tag selected by the applied image policy?
 
> kubectl get deployments.apps nginxhello -o yaml | \
  yq '.spec.template.spec.containers[0].image'
 
#### 15. Fetch the git references from the remote 'Deployment' repo on GitHub (or the git hosting environment you are using). Update the local branch, and inspect the git log.
 
> git fetch

> git pull

> git log -1

